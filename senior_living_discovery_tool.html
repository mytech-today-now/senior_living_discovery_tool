<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè† Find Hidden Gems Near You!</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glassmorphism-ui/dist/glass.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background-color: #e0eafc;
      background-image: linear-gradient(315deg, #e0eafc 0%, #cfdef3 74%);
      color: #333;
      padding: 1rem;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(8.5px);
      -webkit-backdrop-filter: blur(8.5px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 2rem;
      margin: 1rem 0;
    }
    #outputTable {
      overflow-x: scroll;
      max-height: 500px;
    }
    textarea, input[type="file"] {
      width: 100%;
      margin-top: 0.5rem;
    }
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .popup-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .high-score {
      background-color: rgba(144, 238, 144, 0.4);
    }
    .medium-score {
      background-color: rgba(255, 255, 153, 0.4);
    }
    .low-score {
      background-color: rgba(255, 182, 193, 0.4);
    }
    #scoreFilterContainer {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .download-container {
      display: inline-block;
      position: relative;
    }
    .download-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .download-btn:hover {
      background-color: #45a049;
    }
    .download-dropdown {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 4px;
      top: 100%;
      left: 0;
    }
    .download-dropdown a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      cursor: pointer;
    }
    .download-dropdown a:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <h1>üè† Find Hidden Gems Near You!</h1>
  <h3>Senior Living Discovery Tool</h3>
  <p>Generated by <strong>myTech.Today</strong> ‚Äî <em>@mytech-today-now</em> on GitHub</p>

  <button onclick="document.getElementById('popup').style.display='flex'">How this works?</button>
  <div id="popup" class="popup">
    <div class="popup-content">
      <span class="close-btn" onclick="document.getElementById('popup').style.display='none'">‚úñ</span>
      <h2>üß† Under the Hood</h2>
      <p>This application uses the SheetJS library to parse uploaded spreadsheets in .ods, .xlsx, .xls, or .csv format. Each row is interpreted using the columns: Name, Street Number, Street Name, Town, State, and Zip.</p>
      <p>The app builds URLs from those addresses and performs a real web search using the DuckDuckGo search engine to identify useful context around the criteria you enter.</p>
      <p>User-entered criteria are parsed into keywords. Each result summary is scored by matching those keywords, and the final score appears alongside the summary.</p>
      <p>The final table can be edited and downloaded as an .ODS file using a client-side ODS generator.</p>
      <code>Console logs events, parsing, and errors for debugging.</code>
    </div>
  </div>

  <div class="glass-card">
    <h4>üìù Description</h4>
    <p>1. Drag-and-drop or upload your spreadsheet<br>
       2. Add filtering criteria (e.g., ‚Äúclose to nature‚Äù, ‚Äúless than $500‚Äù etc.)<br>
       3. Press Submit<br>
       4. Review results and export as .ODS</p>
  </div>

  <div class="glass-card">
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.ods">
    <textarea id="criteria" rows="4" placeholder="e.g. Needs to be furnished, costs less than $500, accepts pets over 50 lbs">
accepts service animals above 50 lbs., Costs less than $500/month, Assisted or unassisted senior living, close to a hospital, gas station, and grocery store, needs to be furnished, in the state of Illinois, close to a nature area, fewer than 100 residents</textarea>
    <button onclick="processFile()">Submit</button>
    <div class="download-container">
      <button onclick="toggleDownloadDropdown()" class="download-btn">
        Download ‚ñº
      </button>
      <div id="downloadDropdown" class="download-dropdown">
        <a onclick="downloadFile('xlsx')">üìä Excel (.xlsx)</a>
        <a onclick="downloadFile('xls')">üìä Excel Legacy (.xls)</a>
        <a onclick="downloadFile('csv')">üìÑ CSV (.csv)</a>
        <a onclick="downloadFile('ods')">üìã OpenDocument (.ods)</a>
      </div>
    </div>
  </div>

  <div id="scoreFilterContainer" class="glass-card">
    <label for="scoreFilter">Min Score:</label>
    <input type="range" id="scoreFilter" min="0" max="10" value="0" step="1" onchange="filterByScore(this.value)">
    <span id="scoreDisplay">0</span>
  </div>

  <div id="outputTable" class="glass-card">
    <table id="results"></table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let globalData = [];

    function logError(err) {
      console.error("[Error]", err);
    }

    function logEvent(msg) {
      console.log("[Event]", msg);
    }

    async function realSearchQuery(address, criteriaKeywords) {
      const query = encodeURIComponent(`${address} ${criteriaKeywords.join(' ')}`);
      const proxyUrl = `https://api.duckduckgo.com/?q=${query}&format=json&no_redirect=1&skip_disambig=1`;
      try {
        const res = await fetch(proxyUrl);
        const data = await res.json();
        return data.AbstractText || data.RelatedTopics?.[0]?.Text || "No results found";
      } catch (err) {
        logError(err);
        return "Search failed.";
      }
    }

    function scoreKeywords(text, keywords) {
      const lowerText = text.toLowerCase();
      let score = 0;
      keywords.forEach(k => {
        if (lowerText.includes(k.toLowerCase())) score++;
      });
      return score;
    }

    async function processFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const criteriaText = document.getElementById('criteria').value;
      if (!file) return alert("Please upload a file first.");

      const criteriaKeywords = criteriaText.split(',').map(c => c.trim()).filter(Boolean);

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet);

          globalData = [];
          for (const row of json) {
            try {
              const address = `${row['Street Number']} ${row['Street Name']}, ${row['Town']}, ${row['State']} ${row['Zip']}`;
              const scrapedText = await realSearchQuery(address, criteriaKeywords);
              const matchScore = scoreKeywords(scrapedText, criteriaKeywords);
              globalData.push({ ...row, SearchSummary: scrapedText, Score: matchScore });
            } catch (e) {
              logError(e);
              globalData.push(row);
            }
          }

          renderTable(globalData);
          logEvent("Spreadsheet processed and scored.");
        } catch (err) {
          logError(err);
          alert("Failed to process spreadsheet.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderTable(data) {
      const table = document.getElementById('results');
      table.innerHTML = '';
      const headers = Object.keys(data[0] || {});
      const headerRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.innerText = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      data.forEach(row => {
        const tr = document.createElement('tr');
        let score = parseInt(row['Score'], 10);
        if (score >= 5) tr.classList.add('high-score');
        else if (score >= 3) tr.classList.add('medium-score');
        else tr.classList.add('low-score');
        tr.dataset.score = score;

        headers.forEach(h => {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.innerText = row[h] || '';
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    function filterByScore(minScore) {
      const rows = document.querySelectorAll('#results tr');
      document.getElementById('scoreDisplay').textContent = minScore;
      rows.forEach((row, index) => {
        if (index === 0) return; // header row
        const score = parseInt(row.dataset.score || '0', 10);
        row.style.display = score >= minScore ? '' : 'none';
      });
    }

    function toggleDownloadDropdown() {
      const dropdown = document.getElementById('downloadDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    // Close dropdown when clicking outside
    window.onclick = function(event) {
      if (!event.target.matches('.download-btn')) {
        const dropdown = document.getElementById('downloadDropdown');
        if (dropdown.style.display === 'block') {
          dropdown.style.display = 'none';
        }
      }
    }

    function downloadFile(format) {
      try {
        if (!globalData || globalData.length === 0) {
          alert("No data to download. Please process a file first.");
          return;
        }

        const ws = XLSX.utils.json_to_sheet(globalData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

        let filename = "enriched_senior_living_data";
        let fileExtension = format;

        // Handle different formats
        switch(format) {
          case 'xlsx':
            filename += '.xlsx';
            break;
          case 'xls':
            filename += '.xls';
            break;
          case 'csv':
            filename += '.csv';
            break;
          case 'ods':
            filename += '.ods';
            break;
          default:
            filename += '.xlsx';
            fileExtension = 'xlsx';
        }

        XLSX.writeFile(wb, filename);
        logEvent(`${fileExtension.toUpperCase()} file downloaded: ${filename}`);

        // Close dropdown after download
        document.getElementById('downloadDropdown').style.display = 'none';
      } catch (err) {
        logError(err);
        alert(`Failed to generate ${format.toUpperCase()} file.`);
      }
    }
  </script>
</body>
</html>
